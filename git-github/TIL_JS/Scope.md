# 스코프란?

* 프로그래밍 언어는 변수를 선언, 참조, 할당하며 이것으로 프로그램의 상태(state)를 관리한다.

  > 비순수 함수: 함수 내부의 상태만이 아니라 함수 외부 상태까지 변경하는 함수를 비순수 함수(ipmure function)라고 한다. 함수가 외부 상태를 변경하면 상태 변화를 추적하기 어려워지므로 순수 함수(pure function)를 사용하는 것이 좋다.

  ```
  var x = 'global';
  
  function foo() {
    var x = 'local';
    console.log(x); // ①
  }
  
  foo();
  
  console.log(x); // ②
  ```

* 1, 2에서 변수 x를 참조하는데 두개의 변수중에서 어떤것을 참조해야하는지 결정해야 한다.

  * 스코프를 통해 결정한다. 스코프란 식별자를 검색할때 사용하는 규칙.
  * 스코프 내에서 식별자를 찾을때, 자신과 가장 가까운 식별자를 찾는다.

* 함수 foo 내부에서 선언된 변수 x가 있으므로 외부의 x값을 참조하지 않는다. 함수 내에 변수 x의 유효한 범위(스코프)는 함수 내부까지다.

* 객체 내에서 프로퍼티를 찾을때, 변수가 선언되었는지를 확인하고 프로퍼티의 유/무에 따라 없으면 프로퍼티를 만들어 값을 할당하고, 있으면 값을 변경한다.

  ```
  var o = {};
  o.property = 1; // o변수가 있는것을 확인후, property를 만들고 1을 할당.
  ```

* 이런 식으로 자바스크립트 엔진은 코드를 실행할 때, **코드의 문맥(Context)를 고려한다.**

  > 코드의 문맥(Context)과 환경(Environment)
  >
  > 코드가 어디서 실행되고 주변에 어떤 코드들이 있는지 를 환경(Environment)이라고 부른다. 코드의 문맥(Context)은 환경으로 이루어진다. 이를 구현한 것이 실행 컨텍스트(Execution context)이며 모든 코드는 실행 컨텍스트에서 평가되고 실행된다.

* 스코프는 식별자인 변수 이름의 충돌을 방지하여 같은 이름의 변수를 사용할 수 있도록 해준다.

  * 스코프 내에선 식별자가 유일해야 하지만 다른 스코프에는 같은 이름을 사용할 수 있다.
  * var 로 선언된 변수는 같은 스코프 내에서 중복 선언이 허용된다. 이는 의도치 않게 변수값이 변경되는 부작용을 발생시킨다.
  * let이나 const로 선언된 변수는 같은 스코프내에 중복을 허용하지않는다.

* **var로 선언한 변수는 함수 레벨 스코프**를 가지므로 함수 내에서 선언한것이 아니라면 전역 변수가 된다.

  ```
  var var1 = 1; // 코드의 가장 바깥 영역에서 선언된 변수
  
  if (true) {
    var var2 = 2; // 코드 블록 내에서 선언된 변수
    if (true) {
      var var3 = 3; // 중첩된 코드 블록 내에서 선언된 변수
    }
  }
  // 함수 내에서 선언된 변수가 아니여서 다 전역 변수다.
  
  function foo() {
    var var4 = 4; // 함수 내에서 선언된 변수: 지역 변수
  
    function bar() {
      var var5 = 5; // 중첩된 함수 내에서 선언된 변수
    }
  }
  console.log(var1); // 1
  console.log(var2); // 2
  console.log(var3); // 3
  console.log(var4); // ReferenceError: var4 is not defined
  console.log(var5); // ReferenceError: var5 is not defined
  ```

  **모든 식별자는 자신이 선언된 위치에 의해 다른 코드가 식별자 자신을 참조할 수 있는 유효 범위가 결정된다. 이를 스코프(Scope, 유효범위)라 한다.**

  

## 스코프의 종류

코드는 전역(global)과 지역(local)로 구분할 수 있다.

| 구분 | 설명                             | 스코프      | 변수      |
| ---- | -------------------------------- | ----------- | --------- |
| 전역 | 코드의 가장 바깥 영역            | 전역 스코프 | 전역 변수 |
| 지역 | var의경우: 함수 몸체 내부        | 지역 스코프 | 지역 변수 |
| 지역 | let, const의 경우: 코드블록 내부 | 지역 스코프 | 지역 변수 |



#### 전역과 전역 스코프

![img](https://poiemaweb.com/assets/fs-images/12-2.png)

* 전역 변수는 어디서든지 참조할 수 있다.



#### 지역과 지역 스코프(local scope)

* 지역은 var의 경우 함수 몸체 내부, let/const의 경우 코드 블록 내부를 말한다.
* 지역 변수는 자신이 선언된 지역과 하위지역(중첩함수) 에서만 참조할 수 있다.
* **지역 변수는 자신의 지역 스코프와 하위 지역 스코프에서 유효하다.**



## 스코프 체인(Scope chain)

* 함수 몸체 내부에서 함수가 정의한 함수를 중첩 함수(nested function)라한다.
* 중첩 함수를 포함하는 함수를 외부 함수(outer function)라고 부른다.
* 함수가 중첩되면 지역 스코프도 중첩이 된다.
* **스코프는 함수의 중첩/지역의 중첩에 의해 계층적 구조를 갖는다.**
  * 이때 외부함수의 지역 스코프를 중첩 함수의 상위 스코프라 한다.
  * 모든 스코프가 하나의 계층적 구조로 연결된 것을 **스코프 체인**이라 한다.
  * 변수를 참조할 때, 스코프 체인을 통해 참조하는 코드의 스코프에서부터 시작해서 상위 스코프 방향으로 이동하며 선언된 변수를 찾는다.



## 함수 레벨 스코프

* var 키워드는 함수 레벨 스코프를 가지므로, 함수 몸체 내부는 지역 스코프다.

* 함수 내부에 위치하지 않은 변수는 전부 전역 변수가 된다.

  ```
  var i = 10;
  
  // for문에서 선언한 i는 전역 변수이다. 이미 선언된 전역 변수 i가 있으므로 중복 선언된다.
  for (var i = 0; i < 5; i++) {
    console.log(i); // 0 1 2 3 4
  }
  
  // 의도치 않게 변수의 값이 변경되었다.
  console.log(i); // 5
  ```
  * for문 내에서 선언한 변수는 전역 변수가 된다.



## 렉시컬 스코프

```
var x = 1;

function foo() {
  var x = 10;
  bar();
}

function bar() {
  console.log(x);
}

foo(); // 1
bar(); // 1
```

- 함수는 정의와 호출 시기가 다른데, 정의 시점에서 함수를 호출하면 어디서 호출해야 할지 엔진은 알수가 없다.
- 함수가 정의되는 위치에 따라서 상위 스코프가 결정된다. 이것을 lexical scope라고 한다.
  - 렉시컬 스코프(Lexical scope) 또는 정적 스코프(Static scope)라 한다.
- 함수가 어디서 호출됬는지에 따라 상위 스코프가 결정된다.
  - 동적 스코프(Dynamic scope)라 한다.



## 암묵적 전역 변수(implicit global)

```
function foo() {
  // 선언하지 않은 변수에 값을 할당하면 암묵적 전역 변수가 된다.
  x = 10;
}

foo();

console.log(x); // 10
```

- x = 10; 을 엔진이 읽으면 foo scope내에서 변수 x를 찾지만, 없으므로 상위스코프인 전역스코프로 가서 찾는다. 전역 스코프에도 변수 x가 없으므로 전역에서 선언해버린다.
  - 이것을 **암묵적 전역변수(implicit global)**라 한다.
- 따라서 x는 전역 변수가 된다.



#### 모듈(module)

- 타 언어는 JS 파일을 나누면 파일개별로 하나의 스코프가 된다(모듈)
  - 식별자가 같아도 스코프가 달라 괜찮다.
- 자바스크립트는 모듈의 개념이 없어서 파일 두개를 script태그로 연결해도 스코프가 하나여서 파일 두개가 합쳐진것이랑 같다. **자바스크립트는 파일마다 독립적인 파일 스코프를 갖지 않는다.**
  - 파일들간에 전역변수가 중복되면 계속 재할당한다.
  - 여러 파일들을 스코프로 구분해서 뭉치는것: 번들링